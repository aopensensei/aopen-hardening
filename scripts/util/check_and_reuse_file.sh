#!/usr/bin/env bash
#
# check_and_reuse_file.sh
# 引数で指定された中間ファイルを確認し、
# - ファイルがない場合は新規作成フラグを返す
# - ファイルがあれば更新日時を表示し、
#   1) 再利用する
#   2) 中身を確認（編集）する
#   3) 破棄して新規作成する
# の3択から選択させる。
#
# 戻り値:
#   0 => ファイルを再利用する
#   1 => ファイルを確認/編集し、最終的に再利用すると選択
#   2 => ファイルを破棄し、新規作成する (またはファイルが存在しない)
#
# 使用例:
#   check_and_reuse_file.sh /path/to/file.yml
#   RESULT=$?
#   if [ $RESULT -eq 2 ]; then
#     echo "新規作成処理へ進みます..."
#     # ...
#   else
#     echo "再利用処理へ進みます..."
#     # ...
#   fi
#

set -e

# 引数チェック
if [ $# -lt 1 ]; then
  echo "Usage: $0 <filepath>"
  exit 2
fi

FILEPATH="$1"

# -----------------------------------------------------------
# ファイルが存在しない場合
# -----------------------------------------------------------
if [ ! -f "$FILEPATH" ]; then
  echo "===> ファイルが存在しません: $FILEPATH"
  echo "新規作成が必要です。"
  exit 2  # 新規作成へ
fi

# -----------------------------------------------------------
# ファイルが存在する場合
# -----------------------------------------------------------
echo "===> 既存ファイルを検出: $FILEPATH"
LAST_UPDATED="$(stat -c '%y' "$FILEPATH" 2>/dev/null || echo '不明')"
echo "更新日時: $LAST_UPDATED"

# 選択ループ
while true; do
  echo
  echo "次の選択肢があります。"
  echo "  1) ファイルを再利用する"
  echo "  2) 中身を確認・編集する"
  echo "  3) ファイルを破棄して新規作成する"
  echo

  read -p "選択してください (1/2/3): " choice
  case "$choice" in
    1)
      echo "===> ファイルを再利用します。"
      exit 0  # 再利用
      ;;
    2)
      echo "===> ファイルをエディタで開きます..."
      nano "$FILEPATH"
      echo "エディタを終了しました。"
      # エディタで編集後、再度選択肢を表示するためループを継続
      ;;
    3)
      echo "===> ファイルを破棄します。"
      rm -f "$FILEPATH"
      exit 2  # 新規作成へ
      ;;
    *)
      echo "無効な選択肢です。もう一度入力してください。"
      ;;
  esac
done
